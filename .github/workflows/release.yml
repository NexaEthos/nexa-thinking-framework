name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            target: aarch64-apple-darwin
            name: macOS-arm64
          - platform: macos-15
            target: x86_64-apple-darwin
            name: macOS-x64
          - platform: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            name: Linux-x64
          - platform: windows-latest
            target: x86_64-pc-windows-msvc
            name: Windows-x64

    runs-on: ${{ matrix.platform }}
    timeout-minutes: 90
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update version from tag
        shell: bash
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          echo "Updating version to $VERSION"
          
          # Update tauri.conf.json
          sed -i.bak "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" frontend/src-tauri/tauri.conf.json
          rm -f frontend/src-tauri/tauri.conf.json.bak
          
          # Update Cargo.toml
          sed -i.bak "s/^version = \"[^\"]*\"/version = \"$VERSION\"/" frontend/src-tauri/Cargo.toml
          rm -f frontend/src-tauri/Cargo.toml.bak
          
          # Update package.json
          sed -i.bak "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" frontend/package.json
          rm -f frontend/package.json.bak
          
          echo "Updated versions:"
          grep '"version"' frontend/src-tauri/tauri.conf.json
          grep '^version' frontend/src-tauri/Cargo.toml
          grep '"version"' frontend/package.json | head -1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Cache pnpm dependencies
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('frontend/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: frontend/src-tauri

      - name: Install Linux dependencies
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Install Python dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build Python backend
        run: |
          cd backend
          python -m PyInstaller nexa-backend.spec --clean --noconfirm
        shell: bash

      - name: Copy backend to Tauri binaries
        run: |
          mkdir -p frontend/src-tauri/binaries
          echo "=== PyInstaller output ==="
          ls -la backend/dist/
          ls -la backend/dist/nexa-backend/
          cp -r backend/dist/nexa-backend frontend/src-tauri/binaries/
          echo "=== Copied to Tauri binaries ==="
          ls -la frontend/src-tauri/binaries/
          ls -la frontend/src-tauri/binaries/nexa-backend/
        shell: bash

      - name: Install frontend dependencies
        run: |
          cd frontend
          pnpm install

      - name: Import Apple Certificate
        if: startsWith(matrix.platform, 'macos')
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          echo $APPLE_CERTIFICATE | base64 --decode > certificate.p12
          security create-keychain -p actions build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p actions build.keychain
          security import certificate.p12 -k build.keychain -P $APPLE_CERTIFICATE_PASSWORD -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k actions build.keychain
          rm certificate.p12

      - name: Sign PyInstaller binaries for macOS
        if: startsWith(matrix.platform, 'macos')
        env:
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
        run: |
          echo "=== Signing all binaries in nexa-backend bundle ==="
          BACKEND_DIR="frontend/src-tauri/binaries/nexa-backend"
          FRAMEWORK_DIR="$BACKEND_DIR/_internal/Python.framework"
          
          echo "=== Fixing Python.framework structure ==="
          if [ -d "$FRAMEWORK_DIR" ]; then
            PYTHON_REAL=$(readlink -f "$FRAMEWORK_DIR/Versions/Current/Python" 2>/dev/null || readlink "$FRAMEWORK_DIR/Versions/Current/Python")
            PYTHON_VERSION=$(basename "$(dirname "$PYTHON_REAL")")
            
            echo "Python version directory: $PYTHON_VERSION"
            echo "Real Python binary: $PYTHON_REAL"
            
            rm -f "$FRAMEWORK_DIR/Python" 2>/dev/null || true
            rm -rf "$FRAMEWORK_DIR/Versions/Current" 2>/dev/null || true
            rm -rf "$FRAMEWORK_DIR/Resources" 2>/dev/null || true
            
            if [ -f "$FRAMEWORK_DIR/Versions/$PYTHON_VERSION/Python" ]; then
              cp "$FRAMEWORK_DIR/Versions/$PYTHON_VERSION/Python" "$FRAMEWORK_DIR/Python"
              echo "Copied Python binary to framework root"
            fi
            
            echo "Framework structure after fix:"
            ls -la "$FRAMEWORK_DIR/" || true
          fi
          
          echo "=== Signing all binaries in parallel ==="
          
          # Create a signing function for parallel execution
          sign_binary() {
            codesign --force --options runtime --timestamp --sign "$APPLE_SIGNING_IDENTITY" "$1" 2>&1
          }
          export -f sign_binary
          export APPLE_SIGNING_IDENTITY
          
          # Sign all .so and .dylib files in parallel (8 concurrent jobs)
          find "$BACKEND_DIR" -type f \( -name "*.so" -o -name "*.dylib" \) | \
            xargs -P 8 -I {} bash -c 'sign_binary "$@"' _ {}
          
          echo "=== Signing Python binaries ==="
          
          # Sign Python binary at framework root
          if [ -f "$FRAMEWORK_DIR/Python" ]; then
            echo "Signing: $FRAMEWORK_DIR/Python"
            codesign --force --options runtime --timestamp --sign "$APPLE_SIGNING_IDENTITY" "$FRAMEWORK_DIR/Python"
          fi
          
          # Sign Python in Versions directory
          find "$BACKEND_DIR" -path "*/Versions/*/Python" -type f -exec \
            codesign --force --options runtime --timestamp --sign "$APPLE_SIGNING_IDENTITY" {} \;
          
          # Sign standalone Python binary
          if [ -f "$BACKEND_DIR/_internal/Python" ]; then
            echo "Signing: $BACKEND_DIR/_internal/Python"
            codesign --force --options runtime --timestamp --sign "$APPLE_SIGNING_IDENTITY" "$BACKEND_DIR/_internal/Python"
          fi
          
          # Sign the main nexa-backend executable last
          echo "Signing main executable: $BACKEND_DIR/nexa-backend"
          codesign --force --options runtime --timestamp --sign "$APPLE_SIGNING_IDENTITY" "$BACKEND_DIR/nexa-backend"
          
          echo "=== Verifying signatures ==="
          codesign -vvv "$BACKEND_DIR/nexa-backend"
          echo "=== Signing complete ==="

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        with:
          projectPath: frontend
          tagName: ${{ github.ref_name }}
          releaseName: 'Nexa Thinking Framework ${{ github.ref_name }}'
          releaseBody: |
            ## Desktop Application
            
            Download the installer for your platform:
            - **macOS (Apple Silicon)**: `.dmg` file for M1/M2/M3 Macs
            - **macOS (Intel)**: `.dmg` file for Intel Macs  
            - **Windows**: `.msi` installer
            - **Linux**: `.AppImage` or `.deb` package
            
            **Requirements:**
            - An OpenAI-compatible LLM server (LM Studio, Ollama, vLLM)
            - Optionally: Qdrant for RAG features
            
            **Recommended Model:** [LFM2.5-1.2B-Instruct](https://huggingface.co/LiquidAI/LFM2.5-1.2B-Instruct) with 32K context
            
            See [README](https://github.com/NexaEthos/nexa-thinking-framework#readme) for setup instructions.
          releaseDraft: false
          prerelease: false
